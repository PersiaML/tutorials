<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Configuration - PersiaML Tutorials</title>
        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Guide on how to use PersiaML, a large scale sparse model training framework">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../open-in.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../installation.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../getting-started/index.html"><strong aria-hidden="true">3.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../benchmark/index.html"><strong aria-hidden="true">4.</strong> Benchmark</a></li><li class="chapter-item expanded "><a href="../data-processing/index.html"><strong aria-hidden="true">5.</strong> Data Processing</a></li><li class="chapter-item expanded "><a href="../monitoring/index.html"><strong aria-hidden="true">6.</strong> Monitoring</a></li><li class="chapter-item expanded "><a href="../inference/index.html"><strong aria-hidden="true">7.</strong> Inference</a></li><li class="chapter-item expanded "><a href="../model-checkpointing/index.html"><strong aria-hidden="true">8.</strong> Model Checkpointing</a></li><li class="chapter-item expanded "><a href="../configuration/index.html" class="active"><strong aria-hidden="true">9.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../troubleshooting/index.html"><strong aria-hidden="true">10.</strong> Troubleshooting</a></li><li class="chapter-item expanded "><a href="../kubernetes-integration/index.html"><strong aria-hidden="true">11.</strong> Kubernetes Integration</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">PersiaML Tutorials</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/PersiaML/tutorials" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<p>In order to achieve the best performance on various training and inference jobs, PersiaML servers provide a handful of configuration options via two config files, a global configuration file usually named as <code>global_config.yaml</code>, and an embedding configuration file usually named as <code>embedding_config.yaml</code>. The global configuration allows one to define job type and general behaviors of servers, whereas embedding configuration provides definition of embedding details for individual sparse features.</p>
<h2 id="global-configuration"><a class="header" href="#global-configuration">Global Configuration</a></h2>
<p>Global configuration specifies the configuration of the current PersiaML job. The path to the global configuration file should be parsed as argument <code>--global-config</code> when launching PersiaML servers or middleware.</p>
<p>Here is an example for <code>global_config.yaml</code>.</p>
<pre><code class="language-yaml">common_config:
  job_type: Train
  metrics_config:
    enable_metrics: false
    push_interval_sec: 10
embedding_server_config:
  capacity: 100000000
  num_hashmap_internal_shards: 128
  full_amount_manager_buffer_size: 1000
  num_persistence_workers: 4
  num_signs_per_file: 5000000
  enable_incremental_update: false
  incremental_buffer_size: 5000000
  incremental_channel_capacity: 1000
middleware_config:
  forward_buffer_size: 1000
</code></pre>
<p>Depending on the scope, <code>global_config</code> was divided into three major sections, namely <code>common_config</code>, <code>embedding_server_config</code> and <code>middleware_config</code>. <code>common_config</code> configures the job type (<code>job_type</code>) and metrics server. <code>embedding_server_config</code> configures the PersiaML embedding server, and <code>middleware_config</code> provides configurations for the PersiaML middleware. The following is a detailed description of each configuration.</p>
<h3 id="common_config"><a class="header" href="#common_config">common_config</a></h3>
<h4 id="job_type"><a class="header" href="#job_type">job_type</a></h4>
<p>The job_type of PresiaML can be either <code>Train</code> or <code>Infer</code>.</p>
<p>When <code>job_type</code> is <code>Infer</code>, additional configurations including <code>servers</code> and <code>initial_sparse_checkpoint</code> have to be provided. Here is an example:</p>
<pre><code class="language-yaml">common_config:
  job_type: Infer
    servers:
      - emb_server_1:8000
      - emb_server_2:8000
    initial_sparse_checkpoint: /your/sparse/model/dir
</code></pre>
<ul>
<li><code>servers(list of str, required)</code>: list of embedding servers each in the <code>ip:port</code> format.</li>
<li><code>initial_sparse_checkpoint(str, required)</code>: Embedding server will load this ckpt when start.</li>
</ul>
<h4 id="metrics_config"><a class="header" href="#metrics_config">metrics_config</a></h4>
<p><code>metrics_config</code> defines a set of configuration options for monitoring. See <a href="../monitoring/index.html">Monitoring</a> for details.</p>
<ul>
<li><code>enable_metrics(bool, default=false)</code>: Whether to enable metrics.</li>
<li><code>push_interval_sec(int ,default=10)</code>: The interval of pushing metrics to the promethus pushgateway server.</li>
<li><code>job_name(str, default=persia_defalut_job_name)</code>: A name to distinguish your job from others.</li>
</ul>
<h3 id="embedding_server_config"><a class="header" href="#embedding_server_config">embedding_server_config</a></h3>
<p><code>embedding_server_config</code> specifies the configuration for the embedding server.</p>
<ul>
<li><code>capacity(int, default=1,000,000,000)</code>: The capacity of each embedding server. Once the number of indices of an embedding server exceeds the capacity, it will evict embeddings according to <a href="https://en.wikipedia.org/wiki/Cache_replacement_policies#Least_recently_used_(LRU)">LRU</a> policies.</li>
<li><code>num_hashmap_internal_shards(int, default=100)</code>: The number of internal shard of an embedding server. Embeddings are saved in a HashMap which contains multiple shards (sub-hashmaps). Since the CRUD operations need to acquire the lock of a hashmap, acquiring the lock of the sub-hashmap instead of the whole hashmap will be more conducive to concurrency between CRUD operations.</li>
<li><code>full_amount_manager_buffer_size(int, default=1000)</code>: The buffer size of full amount manager. In order to achieve better performance, the embedding server does not traverse the hashmap directly during full dump. Instead, Embedding is submitted asynchronously through full amount manager.</li>
<li><code>num_persistence_workers(int, default=4)</code>: The concurrency of embedding dumping, loading and incremental update.</li>
<li><code>num_signs_per_file(int, default=1,000,000)</code>: Number of embeddings to be saved in each file in the checkpoint directory.</li>
<li><code>enable_incremental_update(bool, default=false)</code>: Whether to enable incremental update.</li>
<li><code>incremental_buffer_size(int, default=1,000,000)</code>: Buffer size for incremental update. Embeddings will be inserted into this buffer after each gradient update, and will only be dumped when the buffer is full. Only valid when <code>enable_incremental_update=true</code>.</li>
<li><code>incremental_dir(str, default=/workspace/incremental_dir/)</code>: The directory for incremental update files to be dumped or loaded.</li>
</ul>
<h3 id="middleware_configs"><a class="header" href="#middleware_configs">middleware_configs</a></h3>
<ul>
<li><code>forward_buffer_size(int, default=1000)</code>: Buffer size for prefoard batch data from data loader.</li>
</ul>
<h2 id="embedding-config"><a class="header" href="#embedding-config">Embedding Config</a></h2>
<p>In addition to <code>global_config</code>, detailed settings related to sparse feature embeddings are provided in a separate embedding configuration file usually named <code>embedding_config.yaml</code>. The path to the embedding config file should be parsed as argument <code>--embedding-config</code> when running PersiaML servers.</p>
<p>Here is an example for <code>embedding_config.yaml</code>.</p>
<pre><code class="language-yaml">feature_index_prefix_bit: 8
slot_config:
  workclass:
    dim: 8
    embedding_summation: true
  education:
    dim: 8
    embedding_summation: true
  marital_status:
    dim: 8
    embedding_summation: true
  occupation:
    dim: 8
    embedding_summation: true
  relationship:
    dim: 8
    embedding_summation: true
  race:
    dim: 8
    embedding_summation: true
  gender:
    dim: 8
    embedding_summation: true
  native_country:
    dim: 8
    embedding_summation: true
feature_groups:
  group1:
    - workclass
    - education
    - race
  group2:
    - marital_status
    - occupation

</code></pre>
<p>The following is a detailed description of each configuration. <code>required</code> means there are no default values.</p>
<ul>
<li>
<p><code>feature_index_prefix_bit(int, default=8)</code>: Number of bits occupied by each feature group. To avoid hash collisions between different features, the first <code>n(n=feature_index_prefix_bit)</code> bits of an index(u64) are taken as the feature bits, and the last <code>64-n</code> bits are taken as the index bits. The original id will be processed before inserted into the hash table, following <code>ID = original_ID % 0~2^(64-n) + index_prefix &lt;&lt; (64-n)</code>. Slots in the same feature group share the same <code>index_prefix</code>, which is automatically generated by Persia according to the <code>feature_groups</code>.</p>
</li>
<li>
<p><code>slots_config(map, required)</code>: <code>slots_config</code> contains all the definitions of Embedding. The key of the map is the feature name, and the value of the map is a struct named <code>SlotConfig</code>. The following is a detailed description of configuration in a <code>SlotConfig</code>.</p>
<ul>
<li><code>dim(int, required)</code>: dim of embedding.</li>
<li><code>sample_fixed_size(int, default=10)</code>: raw embedding placeholder size to fill 3d tensor -&gt; (bs, sample_fix_sized, dim).</li>
<li><code>embedding_summation(bool, default=true)</code>: whether to reduce(summation) embedding before feeding to dense net.</li>
<li><code>sqrt_scaling(bool, default=false)</code>: whether to numerical scaling embedding values.</li>
<li><code>hash_stack_config(struct, default=None)</code>: a method to represent a large number of sparse features with a small amount of Embedding vector. It means mapping the original ID to <code>0~E (E=embedding_size)</code> through <code>n (n=hash_stack_rounds)</code> different hash functions, such as <code>ID_1, ID_2... ID_n</code>. Each such ID corresponds to an embedding vector, then performs reduce(summation) operation among these embedding vectors, as input to the dense net of the original ID.
<ul>
<li><code>hash_stack_rounds(int, default=0)</code>: Embedding hash rounds.</li>
<li><code>embedding_size(int, default=0)</code>: Embedding hash space of each rounds.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>feature_groups(map, default={})</code>: Feature group division. Refer to the description of <code>feature_index_prefix_bit</code>. Feature in one feature group will share the same index prefix.</p>
</li>
</ul>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/PersiaML/tutorials/edit/main/src/configuration/index.md">Edit this file on GitHub.</a></footer>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../model-checkpointing/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../troubleshooting/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../model-checkpointing/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../troubleshooting/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
